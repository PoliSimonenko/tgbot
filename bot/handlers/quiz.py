from telebot import types
import os
from bot.keyboards import get_main_menu

BASE_DIR = os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
QUIZ_IMAGES_DIR = os.path.join(BASE_DIR, 'static', 'quiz_images')

# –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã —Ç–µ—Å—Ç–∞ (10 –≤–æ–ø—Ä–æ—Å–æ–≤)
QUESTIONS = [
    {
        "question": "–ö–∞–∫–æ–π —Ü–≤–µ—Ç –≤–∞–º –±–æ–ª—å—à–µ –Ω—Ä–∞–≤–∏—Ç—Å—è?",
        "options": [
            {"text": "–ù–∞—Å—ã—â–µ–Ω–Ω—ã–π —Å–∏–Ω–∏–π", "traits": {"classic": 2, "modern": 1}},
            {"text": "–ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ö—Ä—É—Å—Ç–∞–ª—å", "traits": {"elegant": 3}},
            {"text": "–Ø—Ä–∫–∏–π –º–Ω–æ–≥–æ—Ü–≤–µ—Ç–Ω—ã–π", "traits": {"creative": 2, "bohemian": 1}},
            {"text": "–¢—ë–ø–ª—ã–π —è–Ω—Ç–∞—Ä–Ω—ã–π", "traits": {"vintage": 2, "cozy": 1}}
        ]
    },
    {
        "question": "–ö–∞–∫–æ–π —Å—Ç–∏–ª—å –≤–∞–º –±–ª–∏–∂–µ?",
        "options": [
            {"text": "–ö–ª–∞—Å—Å–∏–∫–∞", "traits": {"classic": 3}},
            {"text": "–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∏–Ω–∏–º–∞–ª–∏–∑–º", "traits": {"modern": 3}},
            {"text": "–ê–≤–∞–Ω–≥–∞—Ä–¥", "traits": {"creative": 3, "bohemian": 1}},
            {"text": "–í–∏–Ω—Ç–∞–∂", "traits": {"vintage": 3, "cozy": 1}}
        ]
    },
    {
        "question": "–ö–∞–∫–æ–π —Ñ–æ—Ä–º—ã –∏–∑–¥–µ–ª–∏–µ –≤–∞–º –Ω—Ä–∞–≤–∏—Ç—Å—è?",
        "options": [
            {"text": "–°—Ç—Ä–æ–≥–∏–µ –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ", "traits": {"modern": 2, "classic": 1}},
            {"text": "–ü–ª–∞–≤–Ω—ã–µ –∏–∑–≥–∏–±—ã", "traits": {"elegant": 2, "animal": 1}},
            {"text": "–ù–µ–æ–±—ã—á–Ω—ã–µ –∞—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω—ã–µ", "traits": {"creative": 2, "bohemian": 1}},
            {"text": "–¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã", "traits": {"classic": 2, "vintage": 1}}
        ]
    },
    {
        "question": "–ö–∞–∫–æ–π –º–∞—Ç–µ—Ä–∏–∞–ª –≤–∞–º –ø—Ä–∏—è—Ç–Ω–µ–µ?",
        "options": [
            {"text": "–¢—è–∂—ë–ª–æ–µ —Å—Ç–µ–∫–ª–æ", "traits": {"classic": 2, "modern": 1}},
            {"text": "–•—Ä—É—Å—Ç–∞–ª—å", "traits": {"elegant": 3, "animal": 1}},
            {"text": "–¶–≤–µ—Ç–Ω–æ–µ —Å—Ç–µ–∫–ª–æ", "traits": {"creative": 2, "bohemian": 1}},
            {"text": "–ú–∞—Ç–æ–≤–æ–µ —Å—Ç–µ–∫–ª–æ", "traits": {"vintage": 2, "cozy": 1}}
        ]
    },
    {
        "question": "–ö–∞–∫–æ–µ –∏–∑–¥–µ–ª–∏–µ –≤—ã –±—ã –≤—ã–±—Ä–∞–ª–∏ –¥–ª—è –ø–æ–¥–∞—Ä–∫–∞?",
        "options": [
            {"text": "–í–∞–∑—É", "traits": {"classic": 2, "elegant": 1}},
            {"text": "–î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—É—é —Ñ–∏–≥—É—Ä—É", "traits": {"animal": 3, "creative": 1}},
            {"text": "–ù–∞–±–æ—Ä –ø–æ—Å—É–¥—ã", "traits": {"modern": 2, "cozy": 1}},
            {"text": "–†–µ—Ç—Ä–æ –∏–∑–¥–µ–ª–∏–µ", "traits": {"vintage": 3}}
        ]
    },
    {
        "question": "–ö–∞–∫–æ–µ –≤—Ä–µ–º—è —Å—É—Ç–æ–∫ –≤–∞–º –º–∏–ª–µ–µ?",
        "options": [
            {"text": "–£—Ç—Ä–æ", "traits": {"classic": 2, "modern": 1}},
            {"text": "–î–µ–Ω—å", "traits": {"elegant": 2, "animal": 1}},
            {"text": "–í–µ—á–µ—Ä", "traits": {"creative": 2, "bohemian": 1}},
            {"text": "–ù–æ—á—å", "traits": {"vintage": 2, "cozy": 1}}
        ]
    },
    {
        "question": "–ö–∞–∫–æ–π —ç–ª–µ–º–µ–Ω—Ç –¥–µ–∫–æ—Ä–∞ –≤–∞–º –±–ª–∏–∂–µ?",
        "options": [
            {"text": "–°—Ç—Ä–æ–≥–∏–µ –ª–∏–Ω–∏–∏", "traits": {"modern": 3}},
            {"text": "–ü—Ä–∏—Ä–æ–¥–Ω—ã–µ –º–æ—Ç–∏–≤—ã", "traits": {"animal": 3, "elegant": 1}},
            {"text": "–ê–±—Å—Ç—Ä–∞–∫—Ü–∏—è", "traits": {"creative": 3}},
            {"text": "–†–µ—Ç—Ä–æ —ç–ª–µ–º–µ–Ω—Ç—ã", "traits": {"vintage": 3}}
        ]
    },
    {
        "question": "–ö–∞–∫–æ–π –ø—Ä–∞–∑–¥–Ω–∏–∫ –≤–∞–º –Ω—Ä–∞–≤–∏—Ç—Å—è –±–æ–ª—å—à–µ?",
        "options": [
            {"text": "–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ", "traits": {"classic": 3}},
            {"text": "–¢–≤–æ—Ä—á–µ—Å–∫–∏–π –≤–µ—á–µ—Ä", "traits": {"creative": 2, "bohemian": 1}},
            {"text": "–î–æ–º–∞—à–Ω–∏–µ –ø–æ—Å–∏–¥–µ–ª–∫–∏", "traits": {"cozy": 3}},
            {"text": "–¢–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–µ—á–µ—Ä–∏–Ω–∫–∞", "traits": {"animal": 2, "modern": 1}}
        ]
    },
    {
        "question": "–ö–∞–∫–æ–µ –∂–∏–≤–æ—Ç–Ω–æ–µ –≤–∞–º —Å–∏–º–ø–∞—Ç–∏—á–Ω–µ–µ?",
        "options": [
            {"text": "–õ–µ–±–µ–¥—å", "traits": {"elegant": 3}},
            {"text": "–ó–º–µ—è", "traits": {"animal": 3}},
            {"text": "–ö–∞–±–∞–Ω", "traits": {"cozy": 2, "vintage": 1}},
            {"text": "–ü–∞–≤–ª–∏–Ω", "traits": {"creative": 2, "bohemian": 1}}
        ]
    },
    {
        "question": "–ö–∞–∫–æ–π –∞–∫—Å–µ—Å—Å—É–∞—Ä –≤—ã –±—ã –≤—ã–±—Ä–∞–ª–∏?",
        "options": [
            {"text": "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ —á–∞—Å—ã", "traits": {"classic": 3}},
            {"text": "–°—Ç–∏–ª—å–Ω—ã–π —à–∞—Ä—Ñ", "traits": {"modern": 2, "elegant": 1}},
            {"text": "–Ø—Ä–∫–∏–π –±—Ä–∞—Å–ª–µ—Ç", "traits": {"creative": 2, "bohemian": 1}},
            {"text": "–í–∏–Ω—Ç–∞–∂–Ω—ã–π –∫—É–ª–æ–Ω", "traits": {"vintage": 3}}
        ]
    }
]

# –û–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è –±–∞–∑–∞ –∏–∑–¥–µ–ª–∏–π —Å –Ω–æ–≤—ã–º–∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏
PRODUCTS = [
    {
        "id": "vase_nemanka",
        "name": "–í–∞–∑–∞ '–ù–µ–º–∞–Ω–∫–∞'",
        "description": "–í—ã - –≤–æ–ø–ª–æ—â–µ–Ω–∏–µ —ç–ª–µ–≥–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –∏ –≥–∞—Ä–º–æ–Ω–∏–∏. –ö–∞–∫ —ç—Ç–∞ –≤–∞–∑–∞, –≤—ã —É–º–µ–µ—Ç–µ —É–∫—Ä–∞—à–∞—Ç—å —Å–æ–±–æ–π –ª—é–±–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ, —Å–æ–∑–¥–∞–≤–∞—è –≤–æ–∫—Ä—É–≥ –∞—Ç–º–æ—Å—Ñ–µ—Ä—É —É—é—Ç–∞ –∏ –∫—Ä–∞—Å–æ—Ç—ã. –í –≤–∞—Å —Å–æ—á–µ—Ç–∞—é—Ç—Å—è –∫–ª–∞—Å—Å–∏–∫–∞ –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å, –∞ –≤–∞—à–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Å–∏–ª–∞ –∏ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—Ç –æ–∫—Ä—É–∂–∞—é—â–∏—Ö. –í—ã —Ü–µ–Ω–∏—Ç–µ —Ç—Ä–∞–¥–∏—Ü–∏–∏, –Ω–æ –≤—Å–µ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç—ã –Ω–æ–≤—ã–º –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è–º –∏ –ø–µ—Ä–µ–º–µ–Ω–∞–º.",
        "image": "vase_nemanka.jpg",
        "traits": {"classic": 4, "elegant": 3}
    },
    {
        "id": "grafine_volna",
        "name": "–ì—Ä–∞—Ñ–∏–Ω '–í–æ–ª–Ω–∞'",
        "description": "–í—ã - —á–µ–ª–æ–≤–µ–∫ —Å –Ω–µ–æ–±—ã—á–Ω—ã–º –≤–∑–≥–ª—è–¥–æ–º –Ω–∞ –º–∏—Ä –∏ —è—Ä–∫–æ–π –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ—Å—Ç—å—é. –ö–∞–∫ —ç—Ç–æ—Ç –≥—Ä–∞—Ñ–∏–Ω —Å –≤–æ–ª–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–º–∏ —Ñ–æ—Ä–º–∞–º–∏, –≤—ã –Ω–µ –±–æ–∏—Ç–µ—Å—å –≤—ã–¥–µ–ª—è—Ç—å—Å—è –∏ –≤–Ω–æ—Å–∏—Ç—å –≤ –∂–∏–∑–Ω—å –¥—Ä—É–≥–∏—Ö —Å–≤–µ–∂–µ—Å—Ç—å –∏ –¥–≤–∏–∂–µ–Ω–∏–µ. –í–∞—à–∞ —ç–Ω–µ—Ä–≥–∏—è –∑–∞—Ä—è–∂–∞–µ—Ç, –∞ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –ø–æ–º–æ–≥–∞–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å —Ä–µ—à–µ–Ω–∏—è —Ç–∞–º, –≥–¥–µ –¥—Ä—É–≥–∏–µ –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–µ–≥—Ä–∞–¥—ã. –í—ã –ª–µ–≥–∫–æ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç–µ—Å—å –∫ –ø–µ—Ä–µ–º–µ–Ω–∞–º –∏ —É–º–µ–µ—Ç–µ —É–¥–∏–≤–ª—è—Ç—å.",
        "image": "grafine_volna.jpg",
        "traits": {"modern": 4, "creative": 3}
    },
    {
        "id": "bokal_crystal",
        "name": "–ë–æ–∫–∞–ª '–ö—Ä–∏—Å—Ç–∞–ª–ª'",
        "description": "–í—ã - –≤–æ–ø–ª–æ—â–µ–Ω–∏–µ —É—Ç–æ–Ω—á—ë–Ω–Ω–æ—Å—Ç–∏, —á–µ—Å—Ç–Ω–æ—Å—Ç–∏ –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Å–≤–µ—Ç–∞. –ö–∞–∫ –∫—Ä–∏—Å—Ç–∞–ª—å–Ω—ã–π –±–æ–∫–∞–ª, –≤—ã –ø—Ä–∏—Ç—è–≥–∏–≤–∞–µ—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ —Å–≤–æ–µ–π –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é –∏ –∏—Å–∫—Ä–µ–Ω–Ω–æ—Å—Ç—å—é. –í–∞—Å —Ü–µ–Ω—è—Ç –∑–∞ —á–∏—Å—Ç–æ—Ç—É –ø–æ–º—ã—Å–ª–æ–≤, —É–º–µ–Ω–∏–µ —Å–ª—É—à–∞—Ç—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å. –í—ã –ª—é–±–∏—Ç–µ –∫—Ä–∞—Å–∏–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã –∂–∏–∑–Ω–∏ –∏ —É–º–µ–µ—Ç–µ –Ω–∞—Ö–æ–¥–∏—Ç—å —Ä–∞–¥–æ—Å—Ç—å –≤ –¥–µ—Ç–∞–ª—è—Ö. –í–∞—à–∞ –¥—É—à–∞ - –∫–∞–∫ –æ–≥—Ä–∞–Ω—ë–Ω–Ω—ã–π –∫—Ä–∏—Å—Ç–∞–ª–ª, –æ—Ç—Ä–∞–∂–∞—é—â–∏–π —Å–≤–µ—Ç –≤ —Å–∞–º—ã—Ö —Ä–∞–∑–Ω—ã—Ö –æ—Ç—Ç–µ–Ω–∫–∞—Ö.",
        "image": "bokal_crystal.jpg",
        "traits": {"elegant": 4, "classic": 2}
    },
    {
        "id": "stakan_retro",
        "name": "–°—Ç–∞–∫–∞–Ω '–†–µ—Ç—Ä–æ'",
        "description": "–í—ã - —Ö—Ä–∞–Ω–∏—Ç–µ–ª—å –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π –∏ —Å–µ–º–µ–π–Ω—ã—Ö —Ç—Ä–∞–¥–∏—Ü–∏–π. –ö–∞–∫ —ç—Ç–æ—Ç —Å—Ç–∞–∫–∞–Ω, –≤—ã –Ω–∞–¥—ë–∂–Ω—ã, –ø—Ä–æ—Å—Ç—ã –∏ –ª—é–±–∏–º—ã –º–Ω–æ–≥–∏–º–∏ –ø–æ–∫–æ–ª–µ–Ω–∏—è–º–∏. –í –≤–∞—Å —á—É–≤—Å—Ç–≤—É–µ—Ç—Å—è —Ç–µ–ø–ª–æ –¥–æ–º–∞—à–Ω–µ–≥–æ –æ—á–∞–≥–∞, –∞ –≤–∞—à–∞ –¥–æ–±—Ä–æ—Ç–∞ –∏ –∏—Å–∫—Ä–µ–Ω–Ω–æ—Å—Ç—å –¥–µ–ª–∞—é—Ç –≤–∞—Å –Ω–µ–∑–∞–º–µ–Ω–∏–º—ã–º –¥—Ä—É–≥–æ–º. –í—ã —Ü–µ–Ω–∏—Ç–µ –ø—Ä–æ—Å—Ç—ã–µ —Ä–∞–¥–æ—Å—Ç–∏ –∏ —É–º–µ–µ—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∞—Ç–º–æ—Å—Ñ–µ—Ä—É —É—é—Ç–∞ –∏ –¥–æ–≤–µ—Ä–∏—è –≤–æ–∫—Ä—É–≥ —Å–µ–±—è.",
        "image": "stakan_retro.jpg",
        "traits": {"vintage": 4, "classic": 2}
    },
    {
        "id": "crystal_snake",
        "name": "–•—Ä—É—Å—Ç–∞–ª—å–Ω–∞—è –∑–º–µ—è",
        "description": "–í—ã - –∑–∞–≥–∞–¥–æ—á–Ω–∞—è –∏ –º—É–¥—Ä–∞—è –ª–∏—á–Ω–æ—Å—Ç—å, –æ–±–ª–∞–¥–∞—é—â–∞—è –æ—Å–æ–±—ã–º —à–∞—Ä–º–æ–º. –ö–∞–∫ —Ö—Ä—É—Å—Ç–∞–ª—å–Ω–∞—è –∑–º–µ—è, –≤—ã —É–º–µ–µ—Ç–µ –±—ã—Ç—å —Ä–∞–∑–Ω—ã–º–∏: —Ç–æ —Å–ø–æ–∫–æ–π–Ω—ã–º–∏ –∏ —Å–æ–∑–µ—Ä—Ü–∞—Ç–µ–ª—å–Ω—ã–º–∏, —Ç–æ —Å—Ç—Ä–µ–º–∏—Ç–µ–ª—å–Ω—ã–º–∏ –∏ —Ä–µ—à–∏—Ç–µ–ª—å–Ω—ã–º–∏. –í –≤–∞—Å —Å–æ—á–µ—Ç–∞—é—Ç—Å—è –∏–Ω—Ç—É–∏—Ü–∏—è –∏ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π —É–º, –≤—ã –ª–µ–≥–∫–æ –Ω–∞—Ö–æ–¥–∏—Ç–µ –≤—ã—Ö–æ–¥ –∏–∑ —Å–ª–æ–∂–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π –∏ —É–º–µ–µ—Ç–µ –≤–¥–æ—Ö–Ω–æ–≤–ª—è—Ç—å –¥—Ä—É–≥–∏—Ö –Ω–∞ –ø–µ—Ä–µ–º–µ–Ω—ã.",
        "image": "crystal_snake.jpg",
        "traits": {"animal": 4, "elegant": 3, "creative": 2}
    },
    {
        "id": "meshochek",
        "name": "–î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω–æ–µ –∏–∑–¥–µ–ª–∏–µ '–ú–µ—à–æ—á–µ–∫'",
        "description": "–í—ã - —á–µ–ª–æ–≤–µ–∫-—Å—é—Ä–ø—Ä–∏–∑, –≤ –≤–∞—Å –≤—Å–µ–≥–¥–∞ –µ—Å—Ç—å —á—Ç–æ-—Ç–æ –Ω–µ–æ–±—ã—á–Ω–æ–µ –∏ —Ü–µ–Ω–Ω–æ–µ. –ö–∞–∫ —ç—Ç–æ—Ç –¥–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–π –º–µ—à–æ—á–µ–∫, –≤—ã —Ö—Ä–∞–Ω–∏—Ç–µ –≤ —Å–µ–±–µ –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Ç–∞–ª–∞–Ω—Ç–æ–≤ –∏ –∏–¥–µ–π, –∫–æ—Ç–æ—Ä—ã–º–∏ —â–µ–¥—Ä–æ –¥–µ–ª–∏—Ç–µ—Å—å —Å –±–ª–∏–∑–∫–∏–º–∏. –í—ã —É–º–µ–µ—Ç–µ —Ä–∞–¥–æ–≤–∞—Ç—å –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–º–∏ –ø–æ—Å—Ç—É–ø–∫–∞–º–∏ –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∞—Ç–º–æ—Å—Ñ–µ—Ä—É –ø—Ä–∞–∑–¥–Ω–∏–∫–∞ –¥–∞–∂–µ –≤ –æ–±—ã—á–Ω—ã–µ –¥–Ω–∏.",
        "image": "meshochek.jpg",
        "traits": {"creative": 4, "bohemian": 3, "modern": 2}
    },
    {
        "id": "kabank_mugs",
        "name": "–ù–∞–±–æ—Ä –∫—Ä—É–∂–µ–∫ '–ö–∞–±–∞–Ω'",
        "description": "–í—ã - –¥—É—à–∞ –∫–æ–º–ø–∞–Ω–∏–∏, –Ω–∞—Å—Ç–æ—è—â–∏–π –¥—Ä—É–≥ –∏ –≤–µ—Å—ë–ª—ã–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫. –ö–∞–∫ —ç—Ç–æ—Ç –Ω–∞–±–æ—Ä –∫—Ä—É–∂–µ–∫, –≤—ã –≤—Å–µ–≥–¥–∞ –≥–æ—Ç–æ–≤—ã –∫ –≤—Å—Ç—Ä–µ—á–∞–º –∏ —Å–æ–≤–º–µ—Å—Ç–Ω—ã–º –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è–º. –í–∞—Å —Ü–µ–Ω—è—Ç –∑–∞ –æ—Ç–∫—Ä—ã—Ç–æ—Å—Ç—å, —á—É–≤—Å—Ç–≤–æ —é–º–æ—Ä–∞ –∏ —É–º–µ–Ω–∏–µ –Ω–∞—Ö–æ–¥–∏—Ç—å –æ–±—â–∏–π —è–∑—ã–∫ —Å —Ä–∞–∑–Ω—ã–º–∏ –ª—é–¥—å–º–∏. –í—ã –ª—é–±–∏—Ç–µ —Å–æ–±–∏—Ä–∞—Ç—å –¥—Ä—É–∑–µ–π –∑–∞ –æ–¥–Ω–∏–º —Å—Ç–æ–ª–æ–º –∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–µ–∑–∞–±—ã–≤–∞–µ–º—ã–µ –º–æ–º–µ–Ω—Ç—ã —Ä–∞–¥–æ—Å—Ç–∏ –∏ —Ç–µ–ø–ª–∞.",
        "image": "kabank_mugs.jpg",
        "traits": {"cozy": 4, "animal": 3, "vintage": 2}
    }
]


def register_handlers(bot):
    user_profiles = {}

    @bot.message_handler(func=lambda msg: msg.text == "üß™ –¢–µ—Å—Ç '–ö—Ç–æ —Ç—ã –∏–∑ –ø—Ä–æ–¥—É–∫—Ü–∏–∏?'")
    def start_test(message):
        chat_id = message.chat.id
        user_profiles[chat_id] = {
            "current_question": 0,
            "traits": {
                "classic": 0,
                "modern": 0,
                "elegant": 0,
                "creative": 0,
                "vintage": 0,
                "animal": 0,
                "bohemian": 0,
                "cozy": 0
            }
        }
        ask_question(bot, chat_id)

    def ask_question(bot, chat_id):
        profile = user_profiles[chat_id]
        question = QUESTIONS[profile["current_question"]]

        markup = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
        buttons = [types.KeyboardButton(opt["text"]) for opt in question["options"]]
        markup.add(*buttons)
        markup.add(types.KeyboardButton("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å —Ç–µ—Å—Ç"))

        bot.send_message(
            chat_id,
            f"–í–æ–ø—Ä–æ—Å {profile['current_question'] + 1}/{len(QUESTIONS)}:\n{question['question']}",
            reply_markup=markup
        )

    @bot.message_handler(func=lambda msg: user_profiles.get(msg.chat.id) and
                                    msg.text in [opt["text"] for q in QUESTIONS for opt in q["options"]])
    def handle_answer(message):
        chat_id = message.chat.id
        profile = user_profiles[chat_id]
        current_question = QUESTIONS[profile["current_question"]]

        # –ù–∞—Ö–æ–¥–∏–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
        selected = next(opt for opt in current_question["options"] if opt["text"] == message.text)

        # –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
        for trait, value in selected["traits"].items():
            profile["traits"][trait] += value

        # –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É –∏–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        profile["current_question"] += 1
        if profile["current_question"] < len(QUESTIONS):
            ask_question(bot, chat_id)
        else:
            show_result(bot, chat_id)

    def show_result(bot, chat_id):
        profile = user_profiles[chat_id]

        # –ù–∞—Ö–æ–¥–∏–º –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–µ–µ –∏–∑–¥–µ–ª–∏–µ
        best_product = None
        best_score = -1

        for product in PRODUCTS:
            score = 0
            for trait, value in product["traits"].items():
                score += profile["traits"].get(trait, 0) * value

            if score > best_score:
                best_score = score
                best_product = product

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        try:
            image_path = os.path.join(QUIZ_IMAGES_DIR, best_product["image"])
            with open(image_path, 'rb') as photo:
                bot.send_photo(
                    chat_id,
                    photo,
                    caption=f"üéâ –í—ã - <b>{best_product['name']}</b>!\n\n{best_product['description']}",
                    parse_mode="HTML",
                    reply_markup=get_main_menu()
                )
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ: {e}")
            bot.send_message(
                chat_id,
                f"üéâ –í—ã - <b>{best_product['name']}</b>!\n\n{best_product['description']}",
                parse_mode="HTML",
                reply_markup=get_main_menu()
            )

        del user_profiles[chat_id]

    @bot.message_handler(func=lambda msg: user_profiles.get(msg.chat.id) and msg.text == "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å —Ç–µ—Å—Ç")
    def cancel_test(message):
        chat_id = message.chat.id
        bot.send_message(
            chat_id,
            "–¢–µ—Å—Ç –æ—Ç–º–µ–Ω—ë–Ω. –ö–æ–≥–¥–∞ –±—É–¥–µ—Ç–µ –≥–æ—Ç–æ–≤—ã, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞!",
            reply_markup=get_main_menu()
        )
        del user_profiles[chat_id]